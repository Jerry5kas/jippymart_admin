<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foods Activity Logging Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        #results { margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üçΩÔ∏è Foods Activity Logging Test</h1>
    
    <div class="test-section">
        <h2>1. Test logActivity Function Availability</h2>
        <button onclick="testLogActivityAvailability()">Test logActivity Function</button>
        <div id="availability-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test API Endpoint</h2>
        <button onclick="testApiEndpoint()">Test API Endpoint</button>
        <div id="api-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Foods Operations</h2>
        <button onclick="testFoodsCreated()">Test Food Created</button>
        <button onclick="testFoodsUpdated()">Test Food Updated</button>
        <button onclick="testFoodsDeleted()">Test Food Deleted</button>
        <button onclick="testFoodsPublished()">Test Food Published</button>
        <button onclick="testFoodsUnpublished()">Test Food Unpublished</button>
        <div id="foods-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Check Console for Errors</h2>
        <p>Open browser console (F12) and check for any error messages.</p>
        <button onclick="checkConsoleErrors()">Check Console</button>
        <div id="console-result"></div>
    </div>
    
    <div id="results">
        <h3>Test Results:</h3>
        <div id="test-results"></div>
    </div>

    <script>
        // Include the global activity logger
        window.logActivity = function(module, action, description) {
            console.log('üîç logActivity called with:', { module, action, description });
            
            const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            console.log('üîç CSRF Token found:', token ? 'YES' : 'NO');
            
            const data = {
                module: module,
                action: action,
                description: description
            };
            
            if (token) {
                data._token = token;
            }
            
            console.log('üîç Sending AJAX request to /api/activity-logs/log');
            
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: '/api/activity-logs/log',
                    method: 'POST',
                    data: data,
                    success: function(response) {
                        console.log('üîç AJAX Success Response:', response);
                        if (!response.success) {
                            console.error('Failed to log activity:', response.message);
                            reject(new Error(response.message));
                        } else {
                            console.log('‚úÖ Activity logged successfully:', module, action, description);
                            resolve(response);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('‚ùå AJAX Error logging activity:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        console.error('Status Code:', xhr.status);
                        reject(new Error(error || 'Unknown error'));
                    }
                });
            });
        };

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
        }

        function testLogActivityAvailability() {
            const resultDiv = document.getElementById('availability-result');
            
            if (typeof logActivity === 'function') {
                resultDiv.innerHTML = '<span class="success">‚úÖ logActivity function is available</span>';
                addResult('‚úÖ logActivity function is available', 'success');
            } else {
                resultDiv.innerHTML = '<span class="error">‚ùå logActivity function is NOT available</span>';
                addResult('‚ùå logActivity function is NOT available', 'error');
            }
        }

        function testApiEndpoint() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<span class="info">üîÑ Testing API endpoint...</span>';
            
            logActivity('test', 'api_test', 'Test from browser')
                .then(response => {
                    resultDiv.innerHTML = '<span class="success">‚úÖ API endpoint test successful</span>';
                    addResult('‚úÖ API endpoint test successful', 'success');
                })
                .catch(error => {
                    resultDiv.innerHTML = '<span class="error">‚ùå API endpoint test failed: ' + error.message + '</span>';
                    addResult('‚ùå API endpoint test failed: ' + error.message, 'error');
                });
        }

        function testFoodsCreated() {
            logActivity('foods', 'created', 'Created new food: Test Pizza')
                .then(response => {
                    addResult('‚úÖ Food created test successful', 'success');
                })
                .catch(error => {
                    addResult('‚ùå Food created test failed: ' + error.message, 'error');
                });
        }

        function testFoodsUpdated() {
            logActivity('foods', 'updated', 'Updated food: Test Pizza')
                .then(response => {
                    addResult('‚úÖ Food updated test successful', 'success');
                })
                .catch(error => {
                    addResult('‚ùå Food updated test failed: ' + error.message, 'error');
                });
        }

        function testFoodsDeleted() {
            logActivity('foods', 'deleted', 'Deleted food: Test Pizza')
                .then(response => {
                    addResult('‚úÖ Food deleted test successful', 'success');
                })
                .catch(error => {
                    addResult('‚ùå Food deleted test failed: ' + error.message, 'error');
                });
        }

        function testFoodsPublished() {
            logActivity('foods', 'published', 'Published food: Test Pizza')
                .then(response => {
                    addResult('‚úÖ Food published test successful', 'success');
                })
                .catch(error => {
                    addResult('‚ùå Food published test failed: ' + error.message, 'error');
                });
        }

        function testFoodsUnpublished() {
            logActivity('foods', 'unpublished', 'Unpublished food: Test Pizza')
                .then(response => {
                    addResult('‚úÖ Food unpublished test successful', 'success');
                })
                .catch(error => {
                    addResult('‚ùå Food unpublished test failed: ' + error.message, 'error');
                });
        }

        function checkConsoleErrors() {
            const resultDiv = document.getElementById('console-result');
            resultDiv.innerHTML = '<span class="info">‚ÑπÔ∏è Check the browser console (F12) for any error messages</span>';
            addResult('‚ÑπÔ∏è Console check requested - please check browser console for errors', 'info');
        }

        // Auto-test on page load
        window.onload = function() {
            addResult('üöÄ Page loaded, starting auto-tests...', 'info');
            setTimeout(() => {
                testLogActivityAvailability();
                setTimeout(() => {
                    testApiEndpoint();
                }, 1000);
            }, 500);
        };
    </script>
</body>
</html>
